package com.tao.app;


import jakarta.annotation.Resource;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import org.springframework.boot.test.context.SpringBootTest;

import java.util.Scanner;
import java.util.UUID;


@SpringBootTest
class ServiceAppTest {

    @Resource
    private ServiceApp serviceApp;

    @Test
    void testChat() {

        // 随机生成 chatId , 确保不会重复
        // 如果用同一个 chatId 再调用 doChat
        // 那么 advisor 就会从对应 .kryo 中把历史取出作为上下文供模型使用
        String chatId = UUID.randomUUID().toString();

        // 第一轮
        String message = "你好，我是小锯鳄";
        String answer = serviceApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
        // 第二轮
        message = "你是谁？你的角色定位是什么？";
        answer = serviceApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
        // 第三轮
        message = "我叫什么来着？我刚跟你说过，把我的名字复述一遍";
        answer = serviceApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
    }

    /**
     * 测试 RAG 效果
     * 接收的输入参数为 info 和 problem
     * 后续应该不会用到这个了，先不删
     * 确保 提取出的 problem 准确无误后再考虑删除
     */
    @Test
    void doChatWithRag() {
        String info = """
            客户：嗯。
            客服：哎，你好，先生，这边是中国联通，请问您是16675321337的机主本人，对吧？
            客户：对。
            客服：哎，打扰到您了哈，先生，咱们关注到您是2023年五月份入完联通的是联通公司的优质用户。您保持号码增强使用，可以领取每月租家属阳会员话费返还总不返还您2次月话费，良心返还，您四个月，每月返还您6元返还您的话费呢，可以抵扣您的月租和话费的使用哈。先生也是希望您用的好多多支持咱们联通这边，把这个返和话费的优惠为您登记到您这个号码上，您再想清楚1下就可以了，好吧。
            客户：嗯，这个需要什么的，是要办理什么东西的话。
            客服：哎，不用您办理任何东西的哈，家长，咱们就是让您去领取每月多加入员的会员和2线话费返还的哈。你只要保持号码不停机不转暖就可以了。不会对您号码做任何业务改动的还先生。
            客户：嗯。
            客户：嗯，好吧。
            客服：啊，那您先不要挂机哈，先生为了保证您个人的权益，咱们通过联通10016给您下发了1条返还话费的短信。您这边收到短信呢，就是不要挂机，您在短期发下方会付个8回复成功之后，您跟我说1下，您看这边有收到短信吗？先生。
            客服：您收到短信，这边有任何问题都可以问我的哈。先生随时。
            客服：嗯，您看有收到短信吗？您收到短信晚上啦。
            客户：嗯，收到，但是我这个不需要这个。
            客服：你去领取会员和话分享好的呀，先生。
            客户：我这个不是每个月25块钱吗？
            客服：嗯，哎不是的哈，先生，咱们这个每月多加住院的会员权益呢，他是价值25元。您就关注广东联通的微信公众号去领取，来用四个月，不会对你号码做任何义务改变的。您这个会员需要您就关注工作去领取。如果会员没有需求的话，您就不用领取哈，领取话费常了就行了，而且话费呢也会自动到账的，不需要您有其他操作的哈先生。
            客户：啊。
            客户：啊。
            客户：这不是要扣费，是不是？
            客服：您放心先生，咱们是让去领取每月多钱25元的会员和20元话费返还的哈。你有保持号码，不停地不转码就可以了，不会对您号码做任何业务改动的哈。
            客户：喂。
            客服：嗯，您在短信下发回复个8就可以了，先生。
            客服：然后2间话费，我这边给您申请好，它系统就返，还到您号码上了。没？不需要您有其他操作的哈先生。
            客户：好。
            客服：呃，系统识别的，您的回复了，您不要挂机，我给您分机。行，您再挂返还您的话费呢是系统1到3个工作日，系统返还到您1337的这个号码里，这边也给您申请办理25元分享到售后员收到生效转型就可以领取回来的使用了。这消耗立即扣费，就属业之外，扣费赠款不可及扣次月自动续都是您微信关注。广东联通过众号，根据短信咨询转量好，会员每月五号左右系统会下发短信，提醒您继续领取，或者是在单元的领取到具备领取，回自中过期，中途退订，不再返还您的话费。中途退订导航，您的话费，那想想对吧？就不打扰您了，祝您生活和工作愉快再见。
        """;

        String problem = """
          [
            {"问题": "询问是否需要办理业务", "原文摘要": "客户:嗯，这个需要什么的，是要办理什么东西的话。", "解释": "客户对是否需要办理业务表示疑问"}, 
            {"问题": "担心扣费问题", "原文摘要": "客户:这不是要扣费，是不是？", "解释": "客户对活动是否会扣费表示担忧"}
          ]
            """;

        String result = serviceApp.doChatWithRag(info, problem);
        System.out.println("=== RAG 测试输出 ===");
        System.out.println(result);
        Assertions.assertNotNull(result);
        Assertions.assertFalse(result.isBlank());
    }

    /**
     * 测试 RAG 效果
     * 接收的输入参数只有 info
     * 一次性把整段 info 和 problem 送给模型，让模型同时给所有问题分配大类/小类
     */
    @Test
    void doChatWithRag2() {
        String info = """
                客服：您好，中国联通请问是17620317069的机主吗？
                客户：啊，是的。
                客服：来电话是联通达汽油质用户，您保持号码正常使用，可以享受每个月26元话费返还每月呢返您是原话费，连续返还六个月，总共呢还您60元话费，返还话费呢可以拿来抵扣您套餐。月租党费用也是希望你号码用的好呢，多多支持联通。那现在为您当季领取你留意的使用，好吧。
                客户：嗯。
                客服：您好。
                客服：女士，您就把这手机号码正常使用，不停机不转网就可以享受到每个月给您返还的话，费了，连续返还六个月到期之后呢，停止返还活动也是自动失效的。
                客户：很好的。
                客服：嗯，那女士，您不用挂机，为了确保您本人本机想到并话费返还的中国联通10016开头给您发送1条圈短信，您收到短信在短信下方回复数字8就可以登记领取了短信，要给您这个7069的手机号码下发过去了，您看1下收到了吗？
                客服：您看1下如何问题呢？可以随时在线问我没有问题再回复就可以的。女士。
                客户：你告诉他。
                客户：怎么每月26元得两个视频会员在想60分。
                客户：这个是。
                客户：其他有什么变动吗？
                客服：没有女士，你可以领取到两块大招26元的会员，只需要用微信关注公众号，领取来用就可以了。又是原话费呢，是自动到您账户的，按您套餐也是不动的，没有合约，没有捆绑，没有其他增值业务的女士。
                客户：您好嘞，谢谢。
                客服：1866582，对，您就保持手机号码，正当使用，不停机不转网。他这个话费每个月是自动到您账户的，然后六个月活动到期通的活动整体就自动失效失效啦。
                客户：您好的。
                客服：嗯，那女士，您看没有问题，需要您在短信下方回复数字，是您本人本机想要到这个权益的。
                客户：好了。
                客服：收到你的回复了，女士您不用挂机，有个温馨提示给您说1下，您听1下就行。会员呢是在当月利领取到自闭领取呢会自动失效。稍后领会员的时候呢，你办理26元银行助理操上包系统会下发短信，提醒您去领取权益，中途退订，不再返话费，本月生效，次月自动续如期，本月就外扣费赠款不可抵扣。本月开始分六个月到账，每月到账10元，可以抵扣您套餐。月租房费用。稍后呢请根据语音提示N个1对我服务评价格满意。那感谢您的接听，祝您生活愉快，再见女士。
                """;

        String result = serviceApp.doChatWithRag(info);
        System.out.println("=== RAG 测试输出 ===");
        System.out.println(result);
        Assertions.assertNotNull(result);
        Assertions.assertFalse(result.isBlank());
    }


    /**
     * 测试新版 RAG：
     * 对每个 problem 单独调用 classifySingleProblemWithRag 做 RAG 分类，再由 ProblemClassifyTool 合并结果
     * 只传入 info，内部自动：
     * 1）用 ObjectionExtractTool 抽取 problem
     * 2）用 ProblemClassifyTool + RAG 做分类
     */
    @Test
    void doChatWithRag3() {
        String info = """
            客服：您好，请问是13172306204的机主吗？
            客户：啊，是。
            客服：感谢您的接听。这边是广州联通给您来电的，就是留意到您的号码是24年十月份入网的嘛，想让您这个卡长期使用保留下来多多支持联通的那今晚八点之后呢，会帮您做1个网络提速，您还是按您这个司机全国流量到29的卡来用不调整月费的，您放心。另外呢还可以体验1个每月多交20元活动发信用消费。按照您这个卡29的这个4G全国流量网缴费就可以，每个月还可以体验1个一百五十分钟通话和五个G流量。这样您所有资源呢就可以使用5G啦，就是您这个4G全国流量完升级成5G全国流量。哇，而且二29的这个卡利用就可以。
            客服：这样您这两天有空的话，把手机呢关机重启1下，网络，帮您更新好办理好呢，到时候留意使用就可以了，好吧。
            客户：啊，好，知道是。
            客服：嗯，另外呢耽误您二三十秒，就是稍后呢10016系统会发1条短信给您收到短信呢回复1个八，就是确认号码是您在用就可以。您看1下10016的短信收到了吗？
            客服：就是包含150分钟五个G流量的这条短信短信框回复一个八确认号码是您在用。
            客服：用。
            客户：那个为什么要要音频要6块呀什么的那个呢？
            客服：您放心女士，这个活动它是标价20元的活动，但是号码的话已经给您优化过啦。这个是公司感恩回馈联通优质用户的。就是你这个号码呢，保持正常使用。
            客服：系统给您优化，过入到咱产品里的，不调整营月费的放心就可以。
            客服：还有嗯有1个音是特惠包，这个是每月多交6元的1个体验1次，就是本月不交钱呢，可以体验1个十G流量的7天，有效会有短信通知您的，到时候留意用就可以。
            客户：还是后面这些收钱呢？
            客服：不调整您运费的女士。
            客户：如果调整，我就。
            客服：是联通公司，联通公司感恩回馈优质用户的给您优化过了，就是归入到您的这个产品里的，您不是办理的一个四G全国流量吗？29的吗？这样给您优化升级之后呢，您还是29的这个套卡，就是信号给您优化，您这样就可以使用，就升级成5G的这个流量，完29啦。
            客服：其他的。
            客户：其实我那时候买台的时候，他已经说是5G的他但是他为什么给我开4G都没想到。
            客服：嗯。
            客户：嗯。
            客服：您的手机是支持5G但是您当时入网24年不是十月份入网的吗？您办的是一个四G全国流量吗？29的这样给您升级之后，这个就是不需要您更改更贵的那种5G套餐了，就可以直接升级成29的5G卡了。
            客户：好。
            客户：哎，你如果用现在售钱的话，我再投诉啊。
            客服：您放心，女士，这边是系统给您优化过来的，就是感恩回馈联通用户的嘛。
            客户：可以。
            客服：它这个每月多加20元的活动，是就是你还是保留您当前的这个套卡来用。
            客服：用。
            客户：哦，好，那我给你试1下。
            客服：嗯，稍后呢嗯对您说一个八确认一号码是您在用。
            客服：用。
            客服：另外耽误您几秒钟，就是为您登记办理的，每月交多20元的这个5G加油包呀。工作人员会在3个工作日内给您批量更新。您这两天有时间呢，关机重启1下啦。这个生效后期客资源自动续订的语音不完，不转接，流量用不完，那可以转到下个月来继续用的。
            客户：啊，这个这个我知道我1直在用户。
            客服：嗯，这个赠款不抵扣，就是本月可以不交钱，体验一个十G流量7天有效的。
            客户：您现在怎么说够用，但是你说的那个谁私下带这个。
            客服：另外，您小。
            客服：嗯。
            客户：如果你原来都扣费的话，我就我就申请那个啊。
            客户：嗯。
            客服：另外就是麻烦女士稍后收到语音提示呢，麻烦按个1对我的服务评个满意，您的满意对我非常重要，谢谢。
            客户：啊。
            客户：啊，好。
            客服：这样就不打扰您了，生活愉快再见。
            客户：那再见。
            客户：再见。
        """;

        String result = serviceApp.doClassifyWithRag(info);

        System.out.println("=== RAG(新，一键) 测试输出 ===");
        System.out.println(result);

        Assertions.assertNotNull(result);
        Assertions.assertFalse(result.isBlank());
    }
}